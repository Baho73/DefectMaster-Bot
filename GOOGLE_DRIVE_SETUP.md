# Настройка Google Drive для DefectMaster Bot

## Проблема: Storage Quota Exceeded

Если вы получаете ошибку:
```
Service Accounts do not have storage quota. Leverage shared drives or use OAuth delegation instead.
```

Это означает, что сервисный аккаунт не может загружать файлы в "My Drive", так как у него нет собственного хранилища.

## Решение: Создание общей папки

### Шаг 1: Найдите email сервисного аккаунта

1. Откройте файл `service-account.json`
2. Найдите поле `client_email`
3. Скопируйте значение (например: `defectmaster-bot@project-12345.iam.gserviceaccount.com`)

**Альтернативно:**
- Откройте [Google Cloud Console](https://console.cloud.google.com/)
- Перейдите в **IAM & Admin** → **Service Accounts**
- Скопируйте email вашего сервисного аккаунта

### Шаг 2: Создайте папку в Google Drive

1. Откройте [Google Drive](https://drive.google.com)
2. Нажмите **Создать** → **Папка**
3. Назовите папку (например: "DefectMaster Photos")
4. Нажмите **Создать**

### Шаг 3: Поделитесь папкой с сервисным аккаунтом

1. Нажмите правой кнопкой на созданную папку
2. Выберите **Поделиться** (Share)
3. В поле "Добавить пользователей и группы" вставьте email сервисного аккаунта
4. Выберите роль **Редактор** (Editor) в выпадающем меню справа
5. Снимите галочку "Уведомить пользователей" (если есть)
6. Нажмите **Отправить**

### Шаг 4: Получите ID папки

1. Откройте созданную папку в Google Drive
2. Посмотрите на URL в адресной строке:
   ```
   https://drive.google.com/drive/folders/1a2B3c4D5e6F7g8H9i0J
   ```
3. ID папки - это часть после `/folders/`:
   ```
   1a2B3c4D5e6F7g8H9i0J
   ```
4. Скопируйте этот ID

### Шаг 5: Добавьте ID в .env файл

1. Откройте файл `.env` в корне проекта
2. Добавьте или обновите строку:
   ```env
   GOOGLE_DRIVE_FOLDER_ID=1a2B3c4D5e6F7g8H9i0J
   ```
   (замените на ваш реальный ID)
3. Сохраните файл

### Шаг 6: Перезапустите бота

```bash
# Если запущен через systemd
sudo systemctl restart defectmaster-bot

# Если запущен через screen
# Подключитесь к сессии и нажмите Ctrl+C, затем снова запустите:
python main.py

# Если запущен через Docker
docker restart defectmaster-bot
```

## Проверка настройки

Отправьте тестовое фото боту и проверьте:

1. Фото должно загрузиться без ошибок
2. В папке Google Drive должно появиться новое фото
3. В Google Таблице должна быть ссылка на фото

## Дополнительные варианты решения

### Вариант 2: Google Workspace Shared Drive (платно)

Если у вас есть Google Workspace:

1. Создайте Shared Drive в Google Drive
2. Добавьте сервисный аккаунт как участника
3. Получите ID Shared Drive
4. Установите `GOOGLE_DRIVE_FOLDER_ID` как ID Shared Drive

### Вариант 3: OAuth Delegation (сложный)

Для продакшн-сценариев с большим количеством пользователей рассмотрите использование OAuth 2.0 delegation.
Это требует:
- Domain-wide delegation в Google Workspace
- Более сложную настройку аутентификации
- Документация: https://developers.google.com/workspace/guides/create-credentials#service-account

## Часто задаваемые вопросы

**Q: Что произойдет, если не установить GOOGLE_DRIVE_FOLDER_ID?**
A: Вы получите ошибку 403 "storageQuotaExceeded" при попытке загрузить фото.

**Q: Можно ли использовать несколько папок?**
A: Код поддерживает только одну папку. Все фото будут загружаться в указанную папку.

**Q: Как организовать фото по пользователям?**
A: Можете создать подпапки вручную в основной папке и при необходимости адаптировать код.

**Q: Безопасно ли давать доступ сервисному аккаунту?**
A: Да, сервисный аккаунт имеет доступ только к этой папке и не может получить доступ к вашим личным файлам.

**Q: Сколько места доступно?**
A: Используется квота вашего Google Drive аккаунта (15 ГБ бесплатно, больше при подписке).

## Поддержка

Если проблема сохраняется:

1. Проверьте, что email в `service-account.json` совпадает с email, которому вы дали доступ
2. Убедитесь, что дали права "Редактор", а не только "Просмотр"
3. Проверьте, что ID папки скопирован правильно (без пробелов и других символов)
4. Перезапустите бота после изменения `.env`
